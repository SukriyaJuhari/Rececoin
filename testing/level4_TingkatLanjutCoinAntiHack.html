<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Rececoin</title>
</head>

<body>
  
  <h2> Dashboard (level4_Tingkat Lanjut Coin Anti Hack) </h2>
  
  <p><b>Email:</b> <span id="userEmail">Loading...</span></p>
  <p><b>ID:</b> <span id="userUID">Loading...</span></p>
  <p><b>Coins:</b> <span id="userCoins">Loading...</span></p>
  <p><b>Level:</b> <span id="userLevel">Loading...</span></p>
  <p><b>Terakhir Di Claim:</b> <span id="userLastUpdate">Loading...</span></p>
  <button id="addExp">Tambah 10Exp</button>
  <br>
  <br>
  <h2>StudyHalaman</h2>
  <p><a id="lisTugas"></a></p>
   
  <br>
  <button id="btnLogout">Logout</button>
  
  
  <script type="module">
  document.getElementById("lisTugas").innerHTML=`
    <p><a href="/testing/Level1_BacaSemuaDataUser.html">Level1 Baca Semua Data User</a></p>
  <p><a href="/testing/Level2_UpdateDataExpOnly.html">Level2 Update Data ExpOnly</a></p>
  <p><a href="/testing/level3_CoinAntiHack.html">level3 Coin Anti Hack</a></p>
  <p><a href="/testing/level4_TingkatLanjutCoinAntiHack.html">level4 Tingkat Lanjut Coin Anti Hack</a></p>
`;
  
  
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-auth.js";
    import {
      getFirestore,
      doc,
      collection,
      getDoc,
      setDoc,
      updateDoc,
      serverTimestamp,
      query,
      where,
      limit,
      getDocs
    } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-firestore.js";
    
    // ====== CONFIG (ganti kalau perlu) ======
    const firebaseConfig = {
      apiKey: "AIzaSyBfbW0F9qYu7SdIT2cG7IGOZcB3wsuskk8",
      authDomain: "rececoin-76b27.firebaseapp.com",
      projectId: "rececoin-76b27",
      storageBucket: "rececoin-76b27.firebasestorage.app",
      messagingSenderId: "173498076766",
      appId: "1:173498076766:web:f757e9fa76e93b8727aecf"
    };
    
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    
    // Elemen
    const userEmail = document.getElementById("userEmail");
    const userUID = document.getElementById("userUID");
    const userCoins = document.getElementById("userCoins");
    const userLastUpdate = document.getElementById("userLastUpdate");
    const userLevel = document.getElementById("userLevel");
    
    
    
    // saat login -> load user doc
    onAuthStateChanged(auth, async (user) => {
  if (!user) {
    location.href = "/login-singup.html";
    return;
  }

//menampilkan konten
  userEmail.textContent = user.email;
  userUID.textContent = user.uid;

//mendapatkan data user
  const ref = doc(db, "users", user.uid);
  const snap = await getDoc(ref);

  if (snap.exists()) {
    const dat = snap.data();

    userCoins.textContent = dat.coins;
    userLevel.textContent = dat.level;
    userLastUpdate.textContent =
      dat.lastUpdate?.toDate() ?? "Belum pernah";

    document.getElementById("addExp").onclick = async () => {
      try {

        const fresh = await getDoc(ref);
        const d = fresh.data();

        await updateDoc(ref, {
          coins: d.coins - 10,
          lastUpdate: serverTimestamp()
        });

        console.log("+10 Coins!");

      } catch (err) {
        console.error("Gagal update:", err.message);
      }
    };
  }
});
    
    // LOGOUT
    btnLogout.addEventListener("click", async () => {
      try {
        await signOut(auth);
        alert("Logout berhasil");
        location.href = "/login-singup.html";
      } catch (err) {
        alert("Gagal logout: " + err.message);
      }
    });
    
    
    /*
    
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    match /users/{userId} {
allow read: if request.auth != null && request.auth.uid == userId;

      allow update: if

        // field yang boleh diubah
        request.resource.data.keys().hasOnly(["coins","level","lastUpdate"]) &&

        // data lama & baru
        (
          // coins lama & baru
          request.resource.data.coins is int &&
          resource.data.coins is int &&

          // delta perubahan coins
          (request.resource.data.coins - resource.data.coins) <= 10 &&
          (request.resource.data.coins - resource.data.coins) >= -10000 &&

          // coins tidak boleh negatif
          request.resource.data.coins >= 0 &&

          // =======================
          // ANTI-SPAM COOL DOWN
          // =======================
          request.time - resource.data.lastUpdate >= duration.value(3, "s") &&

          // =======================
          // VALIDASI LEVEL
          // (newCoins berada di range level)
          // =======================
          request.resource.data.coins >= request.resource.data.level * 1000 &&
          request.resource.data.coins < (request.resource.data.level + 1) * 1000
        );
    }
  }
}
    
    
    */
  </script>
</body>

</html>