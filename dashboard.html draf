<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Rececoin Dashboard</title>
</head>

<body>
  <h2>Rececoin — Dashboard (Wireframe)</h2>
  
  <p><b>Email:</b> <span id="userEmail">Loading...</span></p>
  <p><b>Coins:</b> <span id="userCoins">0</span></p>
  
  <label for="actionSelect">Pilih aksi:</label>
  <select id="actionSelect">
    <option value="daily">Daily Reward</option>
    <option value="survey">Survey</option>
    <option value="shortlink">Shortlink</option>
    <option value="watch_ads">Tonton Iklan</option>
    <option value="game">Mini-game</option>
  </select>
  
  <button id="btnCreateToken">Buat Token & Claim</button>
  <p id="status"></p>
  
  <button id="btnLogout">Logout</button>
  
  
  
  
  
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-auth.js";
    import {
      getFirestore,
      doc,
      collection,
      getDoc,
      setDoc,
      updateDoc,
      serverTimestamp,
      query,
      where,
      limit,
      getDocs
    } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-firestore.js";
    
    // ====== CONFIG (ganti kalau perlu) ======
    const firebaseConfig = {
      apiKey: "AIzaSyBfbW0F9qYu7SdIT2cG7IGOZcB3wsuskk8",
      authDomain: "rececoin-76b27.firebaseapp.com",
      projectId: "rececoin-76b27",
      storageBucket: "rececoin-76b27.firebasestorage.app",
      messagingSenderId: "173498076766",
      appId: "1:173498076766:web:f757e9fa76e93b8727aecf"
    };
    
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    
    // Elemen
    const userEmailEl = document.getElementById("userEmail");
    const userCoinsEl = document.getElementById("userCoins");
    const btnCreateToken = document.getElementById("btnCreateToken");
    const statusEl = document.getElementById("status");
    const actionSelect = document.getElementById("actionSelect");
    const btnLogout = document.getElementById("btnLogout");
    
    let currentUser = null;
    let currentUserData = null;
    
    
    
    // saat login -> load user doc
    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        location.href = "/login-singup.html";
        return;
      }
      
      currentUser = user;
      userEmailEl.textContent = user.email || user.uid;
      
      // ========= PENTING! PANGGIL INI =========
      await initUserData(user.uid);
      // ========================================
      
      // ambil data user setelah diperbaiki
      const ref = doc(db, "users", user.uid);
      const snap = await getDoc(ref);
      currentUserData = snap.data();
      userCoinsEl.textContent = currentUserData.coins || 0;
    });
    
    
    async function initUserData(uid) {
      const userRef = doc(db, "users", uid);
      const userSnap = await getDoc(userRef);
      
      if (!userSnap.exists()) {
        await setDoc(userRef, {
          coins: 0,
          lastAction: "",
          lastClaim: {
            daily: new Date(0),
            survey: new Date(0),
            shortlink: new Date(0),
            watch_ads: new Date(0),
            game: new Date(0)
          },
          tokenId: ""
        });
        return;
      }
      
      
      // jika user sudah ada tetapi ada field yang hilang → tambahkan
      const userData = userSnap.data();
      let needFix = false;
      const updates = {};
      
      if (userData.coins === undefined) {
        updates.coins = 0;
        needFix = true;
      }
      if (!userData.lastClaim) {
        updates.lastClaim = {
          daily: new Date(0),
          survey: new Date(0),
          shortlink: new Date(0),
          watch_ads: new Date(0),
          game: new Date(0)
        };
        needFix = true;
      }
      
      if (userData.lastAction === undefined) {
        updates.lastAction = "";
        needFix = true;
      }
      if (userData.tokenId === undefined) {
        updates.tokenId = "";
        needFix = true;
      }
      
      if (needFix) {
        await updateDoc(userRef, updates);
        console.log("User data fixed.");
      }
    }
    
    
    
    
    
    // Buat token unik di subcollection users/{uid}/tokens/{tokenId}
    // Ambil token aktif atau buat baru (aman)
    async function getOrCreateToken(action) {
      const tokensRef = collection(db, "users", currentUser.uid, "tokens");
      
      // cek token aktif existing
      const q = query(tokensRef,
        where("action", "==", action),
        where("used", "==", false),
        limit(1)
      );
      
      const snap = await getDocs(q);
      
      // jika sudah ada token aktif → pakai itu
      if (!snap.empty) {
        const docSnap = snap.docs[0];
        return { id: docSnap.id, data: docSnap.data() };
      }
      
      // kalau tidak ada → buat token baru
      const tokenId = crypto.randomUUID();
      const tokenRef = doc(db, "users", currentUser.uid, "tokens", tokenId);
      
      await setDoc(tokenRef, {
        action: action,
        createdAt: serverTimestamp(),
        used: false
      });
      
      return { id: tokenId, data: { action, createdAt: new Date(), used: false } };
    }
    
    
    
    function getRewardAmount(action) {
      switch (action) {
        case "daily":
          return 10;
        case "survey":
          return 20;
        case "shortlink":
          return 5;
        case "watch_ads":
          return 2;
        case "game":
          return 15;
        default:
          return 0;
      }
    }
    
    
    
    
    
    // Claim reward (satu tombol): create token -> update users doc -> mark token used
    
    btnCreateToken.addEventListener("click", async () => {
      if (!currentUser) return alert("Belum login.");
      
      const action = actionSelect.value;
      if (!action) return alert("Pilih aksi.");
      
      statusEl.textContent = "Sedang memproses data...";
      
      try {
        // 1. Ambil referensi user
        const userRef = doc(db, "users", currentUser.uid);
        
        // 2. AMBIL DATA TERBARU DARI SERVER SEKARANG (PENTING!)
        // Ini mencegah error "null" dan memastikan koin sinkron
        const userSnap = await getDoc(userRef);
        
        if (!userSnap.exists()) {
          throw new Error("Data user tidak ditemukan di database.");
        }
        
        const freshData = userSnap.data(); // Data segar langsung dari DB
        const currentCoins = freshData.coins || 0; // Aman, tidak akan null
        
        // 3. Siapkan token
        statusEl.textContent = "Menyiapkan token...";
        const token = await getOrCreateToken(action);
        
        // 4. Hitung reward
        const reward = getRewardAmount(action);
        const newTotalCoins = currentCoins + reward;
        
        statusEl.textContent = "Mengirim data ke server...";
        
        // 5. Update ke Firestore
        await updateDoc(userRef, {
          coins: newTotalCoins, // Koin baru yang sudah dihitung
          lastAction: action,
          tokenId: token.id,
          [`lastClaim.${action}`]: serverTimestamp()
        });
        
        // 6. Tandai token sudah dipakai
        const tokenRef = doc(db, "users", currentUser.uid, "tokens", token.id);
        await updateDoc(tokenRef, { used: true });
        
        // 7. Sukses & Update UI
        statusEl.textContent = `Klaim berhasil! Dapat ${reward} koin.`;
        
        // Update tampilan koin di layar
        userCoinsEl.textContent = newTotalCoins;
        
        // Update variabel global (opsional, untuk cache saja)
        currentUserData = freshData;
        currentUserData.coins = newTotalCoins;
        
      } catch (err) {
        console.error(err);
        statusEl.textContent = "Error: " + err.message;
        alert("Terjadi kesalahan: " + err.message);
      }
    });
    
    
    
    
    
    
    
    
    
    btnLogout.addEventListener("click", async () => {
      await signOut(auth);
      location.href = "index.html";
    });
  </script>
</body>

</html>